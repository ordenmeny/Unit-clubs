from django.contrib.auth import get_user_model
from django.contrib.auth.mixins import LoginRequiredMixin
from django.shortcuts import redirect
from django.urls import reverse_lazy

from app_clubs.models import Club


class DataMixin:
    # Создается объект класса CreateView.
    # В нем ищется атрибут extra_context.
    # Но находится в родительском классе DataMixin
    # В инициализаторе extra_context изменяется: в него добавляется атрибут item_selected.
    extra_context = {}
    item_selected = None

    def __init__(self):
        # self - ссылка на класс CreateView
        self.extra_context['item_selected'] = self.item_selected


class RequiredClubMember(LoginRequiredMixin):
    for_admin = False

    def dispatch(self, request, *args, **kwargs):
        # получаем объекты пользователя и клуба
        current_user = request.user
        current_club = Club.objects.get(slug=self.kwargs['club_slug'])
        # делаем проверку, есть ли такой клуб у пользователя. Если нет-редирект!
        if not (current_club in current_user.clubs.all()):
            return redirect(reverse_lazy('app_clubs:home_page'))

        # Является ли страница только для админов? Проверка на админство
        if self.for_admin:
            if request.user not in current_club.admins.all():
                return redirect(reverse_lazy('app_clubs:home_page'))


        request.current_club = current_club
        return super().dispatch(request, *args, **kwargs)
# {'environ': {'PATH': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs/.venv/bin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/Apple/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin', '__CFBundleIdentifier': 'com.jetbrains.pycharm', 'PYTHONPATH': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs:/Applications/PyCharm.app/Contents/plugins/python/helpers/pycharm_matplotlib_backend:/Applications/PyCharm.app/Contents/plugins/python/helpers/pycharm_display', 'SHELL': '/bin/zsh', 'PYTHONIOENCODING': 'UTF-8', 'OLDPWD': '/', 'USER': 'dmitryalexandrov', 'TMPDIR': '/var/folders/8_/9n5_d0yd4wb6k2mh0gh4lf5c0000gn/T/', 'COMMAND_MODE': 'unix2003', 'PS1': '(.venv) ', 'SSH_AUTH_SOCK': '/private/tmp/com.apple.launchd.2wocREdZ8Z/Listeners', 'PYCHARM_INTERACTIVE_PLOTS': '1', 'VIRTUAL_ENV': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs/.venv', 'XPC_FLAGS': '0x0', 'PYTHONUNBUFFERED': '1', '__CF_USER_TEXT_ENCODING': '0x1F5:0x7:0x31', 'LOGNAME': 'dmitryalexandrov', 'LC_CTYPE': 'ru_RU.UTF-8', 'XPC_SERVICE_NAME': 'application.com.jetbrains.pycharm.607933.5848686', 'PWD': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs', 'IDEA_INITIAL_DIRECTORY': '/', 'PYCHARM_HOSTED': '1', 'HOME': '/Users/dmitryalexandrov', 'PYCHARM_DISPLAY_PORT': '63342', 'DJANGO_SETTINGS_MODULE': 'project_clubs.settings', 'TZ': 'UTC', 'RUN_MAIN': 'true', 'SERVER_NAME': '1.0.0.127.in-addr.arpa', 'GATEWAY_INTERFACE': 'CGI/1.1', 'SERVER_PORT': '8000', 'REMOTE_HOST': '', 'CONTENT_LENGTH': '', 'SCRIPT_NAME': '', 'SERVER_PROTOCOL': 'HTTP/1.1', 'SERVER_SOFTWARE': 'WSGIServer/0.2', 'REQUEST_METHOD': 'GET', 'PATH_INFO': '/newsmobile/profile-club/', 'QUERY_STRING': '', 'REMOTE_ADDR': '127.0.0.1', 'CONTENT_TYPE': 'text/plain', 'HTTP_HOST': '127.0.0.1:8000', 'HTTP_SEC_FETCH_SITE': 'none', 'HTTP_COOKIE': 'csrftoken=jGQnUJS7olqnWtABO3236ongDcnKBlOt; sessionid=marett1k1qko9bx5px7240p42h727enw', 'HTTP_CONNECTION': 'keep-alive', 'HTTP_UPGRADE_INSECURE_REQUESTS': '1', 'HTTP_SEC_FETCH_MODE': 'navigate', 'HTTP_ACCEPT': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8', 'HTTP_USER_AGENT': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.4 Safari/605.1.15', 'HTTP_ACCEPT_LANGUAGE': 'ru', 'HTTP_SEC_FETCH_DEST': 'document', 'HTTP_ACCEPT_ENCODING': 'gzip, deflate', 'wsgi.input': <django.core.handlers.wsgi.LimitedStream object at 0x10721ba60>, 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>, 'wsgi.version': (1, 0), 'wsgi.run_once': False, 'wsgi.url_scheme': 'http', 'wsgi.multithread': True, 'wsgi.multiprocess': False, 'wsgi.file_wrapper': <class 'wsgiref.util.FileWrapper'>, 'CSRF_COOKIE': 'jGQnUJS7olqnWtABO3236ongDcnKBlOt'}, 'path_info': '/newsmobile/profile-club/', 'path': '/newsmobile/profile-club/', 'META': {'PATH': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs/.venv/bin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Library/Apple/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin', '__CFBundleIdentifier': 'com.jetbrains.pycharm', 'PYTHONPATH': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs:/Applications/PyCharm.app/Contents/plugins/python/helpers/pycharm_matplotlib_backend:/Applications/PyCharm.app/Contents/plugins/python/helpers/pycharm_display', 'SHELL': '/bin/zsh', 'PYTHONIOENCODING': 'UTF-8', 'OLDPWD': '/', 'USER': 'dmitryalexandrov', 'TMPDIR': '/var/folders/8_/9n5_d0yd4wb6k2mh0gh4lf5c0000gn/T/', 'COMMAND_MODE': 'unix2003', 'PS1': '(.venv) ', 'SSH_AUTH_SOCK': '/private/tmp/com.apple.launchd.2wocREdZ8Z/Listeners', 'PYCHARM_INTERACTIVE_PLOTS': '1', 'VIRTUAL_ENV': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs/.venv', 'XPC_FLAGS': '0x0', 'PYTHONUNBUFFERED': '1', '__CF_USER_TEXT_ENCODING': '0x1F5:0x7:0x31', 'LOGNAME': 'dmitryalexandrov', 'LC_CTYPE': 'ru_RU.UTF-8', 'XPC_SERVICE_NAME': 'application.com.jetbrains.pycharm.607933.5848686', 'PWD': '/Users/dmitryalexandrov/PycharmProjects/Unit_clubs', 'IDEA_INITIAL_DIRECTORY': '/', 'PYCHARM_HOSTED': '1', 'HOME': '/Users/dmitryalexandrov', 'PYCHARM_DISPLAY_PORT': '63342', 'DJANGO_SETTINGS_MODULE': 'project_clubs.settings', 'TZ': 'UTC', 'RUN_MAIN': 'true', 'SERVER_NAME': '1.0.0.127.in-addr.arpa', 'GATEWAY_INTERFACE': 'CGI/1.1', 'SERVER_PORT': '8000', 'REMOTE_HOST': '', 'CONTENT_LENGTH': '', 'SCRIPT_NAME': '', 'SERVER_PROTOCOL': 'HTTP/1.1', 'SERVER_SOFTWARE': 'WSGIServer/0.2', 'REQUEST_METHOD': 'GET', 'PATH_INFO': '/newsmobile/profile-club/', 'QUERY_STRING': '', 'REMOTE_ADDR': '127.0.0.1', 'CONTENT_TYPE': 'text/plain', 'HTTP_HOST': '127.0.0.1:8000', 'HTTP_SEC_FETCH_SITE': 'none', 'HTTP_COOKIE': 'csrftoken=jGQnUJS7olqnWtABO3236ongDcnKBlOt; sessionid=marett1k1qko9bx5px7240p42h727enw', 'HTTP_CONNECTION': 'keep-alive', 'HTTP_UPGRADE_INSECURE_REQUESTS': '1', 'HTTP_SEC_FETCH_MODE': 'navigate', 'HTTP_ACCEPT': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8', 'HTTP_USER_AGENT': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.4 Safari/605.1.15', 'HTTP_ACCEPT_LANGUAGE': 'ru', 'HTTP_SEC_FETCH_DEST': 'document', 'HTTP_ACCEPT_ENCODING': 'gzip, deflate', 'wsgi.input': <django.core.handlers.wsgi.LimitedStream object at 0x10721ba60>, 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>, 'wsgi.version': (1, 0), 'wsgi.run_once': False, 'wsgi.url_scheme': 'http', 'wsgi.multithread': True, 'wsgi.multiprocess': False, 'wsgi.file_wrapper': <class 'wsgiref.util.FileWrapper'>, 'CSRF_COOKIE': 'jGQnUJS7olqnWtABO3236ongDcnKBlOt'}, 'method': 'GET', 'content_type': 'text/plain', 'content_params': {}, '_stream': <django.core.handlers.wsgi.LimitedStream object at 0x107528f70>, '_read_started': False, 'resolver_match': ResolverMatch(func=app_clubs.views.ProfileClub, args=(), kwargs={'club_slug': 'newsmobile'}, url_name='profile_club', app_names=['app_clubs'], namespaces=['app_clubs'], route='<slug:club_slug>/profile-club/', captured_kwargs={'club_slug': 'newsmobile'}), 'COOKIES': {'csrftoken': 'jGQnUJS7olqnWtABO3236ongDcnKBlOt', 'sessionid': 'marett1k1qko9bx5px7240p42h727enw'}, 'session': <django.contrib.sessions.backends.db.SessionStore object at 0x107528ee0>, 'user': <SimpleLazyObject: <User: ordenmeny>>, '_messages': <FallbackStorage: request=<WSGIRequest: GET '/newsmobile/profile-club/'>>, 'csrf_processing_done': True, '_cached_user': <User: ordenmeny>, 'current_club': <Club: NewsMobile>}